<div class="stock-adjustment">
  <h2>Admin: Stock Adjustment</h2>

  <form [formGroup]="form" (ngSubmit)="submit()" class="card card-body mb-4">
    <div class="grid">
      <div class="form-group">
        <label>Product</label>
        <select class="form-control" formControlName="productId">
          <option [ngValue]="null">-- Select product --</option>
          <option *ngFor="let p of products" [ngValue]="p.productID">
            {{ p.name }} (On-hand: {{ p.stockQuantity }})
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Qty Adjustment (Â±)</label>
        <input type="number" class="form-control" formControlName="adjustmentQty"/>
        <small class="muted">Use negative values to reduce stock.</small>
      </div>

      <div class="form-group">
        <label>Reason</label>
        <select class="form-control" formControlName="reason">
          <option [ngValue]="null">-- Select reason --</option>
          <option *ngFor="let r of activeReasons" [ngValue]="r.name">{{ r.name }}</option>
        </select>
        <small class="muted">Exact text is stored for audit.</small>
      </div>

      <!-- Replaced dropdown with non-editable chip -->
      <div class="form-group">
        <label>Adjusted By</label>
        <div class="chip">{{ currentStaffDisplay }}</div>
        <input type="hidden" formControlName="adjustedBy" />
      </div>
    </div>

    <div class="actions">
      <button type="submit" class="btn btn-primary" [disabled]="form.invalid">
        Apply Adjustment
      </button>
    </div>
  </form>

  <div *ngIf="errorMessages.length" class="alert alert-danger">
    <h5>Validation Errors</h5>
    <ul><li *ngFor="let msg of errorMessages">{{ msg }}</li></ul>
  </div>

  <hr class="divider" />

  <!-- ===== Manage Reasons (unchanged UI) ===== -->
  <div class="reasons-header">
    <h3>Manage Stock Adjustment Reasons</h3>
    <label class="toggle">
      <input type="checkbox" [(ngModel)]="showInactive" (change)="refreshReasons()" />
      <span>Show inactive</span>
    </label>
  </div>

  <div class="card card-body mb-3">
    <form [formGroup]="reasonForm" (ngSubmit)="saveReason()">
      <div class="grid">
        <div class="form-group" [class.invalid]="(rf.name.touched || triedReasonSubmit) && rf.name.invalid">
          <label>Name</label>
          <input class="form-control" formControlName="name" placeholder="e.g. Damaged / write-off"/>
          <small class="error" *ngIf="(rf.name.touched || triedReasonSubmit) && rf.name.hasError('required')">
            Name is required.
          </small>
        </div>

        <div class="form-group" [class.invalid]="(rf.sortOrder.touched || triedReasonSubmit) && rf.sortOrder.invalid">
          <label>Sort Order</label>
          <input type="number" min="1" class="form-control" formControlName="sortOrder" />
          <small class="error" *ngIf="(rf.sortOrder.touched || triedReasonSubmit) && rf.sortOrder.hasError('min')">
            Minimum is 1.
          </small>
        </div>

        <div class="form-group checkbox-group">
          <label class="checkbox">
            <input type="checkbox" formControlName="isActive" />
            <span>Active</span>
          </label>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" type="submit" [disabled]="reasonForm.invalid">
          {{ editingReason ? 'Update' : 'Create' }}
        </button>
        <button *ngIf="editingReason" class="btn btn-ghost" type="button" (click)="cancelEdit()">Cancel</button>
      </div>
    </form>
  </div>

  <div class="history-table">
    <table class="table">
      <thead>
        <tr>
          <th class="th-name">Name</th>
          <th>Status</th>
          <th>Sort</th>
          <th class="th-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of tableReasons">
          <td>{{ r.name }}</td>
          <td>
            <span class="badge" [class.badge-success]="r.isActive" [class.badge-muted]="!r.isActive">
              {{ r.isActive ? 'Active' : 'Inactive' }}
            </span>
          </td>
          <td>{{ r.sortOrder }}</td>
          <td class="actions-cell">
            <button class="btn btn-outline-pink btn-icon" (click)="startEdit(r)" title="Edit">
              <svg width="22" height="22" fill="none" stroke="#e91e63" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M3 17.25V21h3.75l11-11.02-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
              </svg>
              <span>Edit</span>
            </button>

            <button *ngIf="r.isActive" class="btn btn-outline-grey" (click)="deactivateReason(r)">Deactivate</button>
            <button *ngIf="!r.isActive" class="btn btn-outline-pink" (click)="activateReason(r)">Activate</button>
          </td>
        </tr>

        <tr *ngIf="!tableReasons.length">
          <td colspan="4" class="text-center text-muted">No reasons configured.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <hr class="divider" />

  <h3>Past Stock Adjustments</h3>
  <div class="history-table">
    <table class="table">
      <thead>
        <tr>
          <th>#</th><th>Product</th><th>Qty</th><th>Reason</th><th>By</th><th>Date</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let a of adjustments">
          <td>{{ a.stockAdjustmentId }}</td>
          <td>{{ getProductLabel(a.productId) }}</td>
          <td>{{ a.adjustmentQty }}</td>
          <td>{{ a.reason }}</td>
          <td>{{ getEmployeeLabel(a.adjustedBy) }}</td>
          <td>{{ a.adjustmentDate | date:'short' }}</td>
        </tr>
        <tr *ngIf="!adjustments.length">
          <td colspan="6" class="text-center text-muted">No adjustments recorded yet.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
